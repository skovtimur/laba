@using Laba.Shared.Exceptions
@using Laba.WebClient.Models
@using Laba.WebClient.Models.Validators

@inherits BaseComponent
@page "/login-by-handshake"

<AuthorizeView>
    <NotAuthorized>
        <MudCard Width="600px" Class="mudcard" Outlined="true">
            <MudCardHeader>
                <CardHeaderContent>
                    <MudText>Log in by Handshake</MudText>
                    @if (IsEverythingValid)
                    {
                        <MudText Color="Color.Success">Valid</MudText>
                    }
                    else
                    {
                        <MudText Color="Color.Error">Invalid</MudText>
                    }
                </CardHeaderContent>
            </MudCardHeader>
            <MudForm @ref="_form" Model="_model" Validation="@(_validator.ValidateValue)" ValidationDelay="0"
                     Spacing="4">
                <MudCardContent>
                    <MudTextField T="string" Label="Email" Required="true" RequiredError="Email is required!"
                                  InputType="InputType.Email" Immediate="true"
                                  Error="@(!IsUserExisting)" ErrorText="@(_isUserExistingErrorText)"
                                  @bind-Value="_model.Email" For="@(() => _model.Email)" Style="margin:2vh"/>
                    <MudTextField T="string" Label="Password" Required="true" RequiredError="Password is required!"
                                  InputType="InputType.Password" Immediate="true"
                                  Error="@(!IsPasswordRight)" ErrorText="@(_isPasswordRightErrorText)"

                                  @bind-Value="_model.Password" For="@(() => _model.Password)" Style="margin:2vh"/>

                    @if (_attemptsCount > 0)
                    {
                        <MudText
                            Color="@(_attemptsCount >= 2 ? Color.Primary : Color.Warning)">@($"You have attempts {_attemptsCount} to write the right password")</MudText>
                    }
                    else
                    {
                        <MudText Color="Color.Error">@($"You don't have attempts, just wait a few minutes")</MudText>
                    }
                </MudCardContent>
                <MudCardActions>
                    <MudLink Href="/login" Color="Color.Primary">Log in as Usual</MudLink>
                    <MudSpacer/>
                    <MudButton Variant="Variant.Filled" Color="Color.Primary"
                               OnClick="@(async () => await OnLoginAsync())"
                               Class="ml-auto" ButtonType="ButtonType.Button">
                        Log in
                    </MudButton>
                </MudCardActions>
            </MudForm>
        </MudCard>
    </NotAuthorized>
    <Authorized>
        @{
            NavTo("/");
        }
    </Authorized>
</AuthorizeView>

@code {
    private bool IsEverythingValid => _form.IsValid;

    private MudForm _form;

    private readonly LoginModel _model = new();
    private LoginModelValidator _validator;
    private int _attemptsCount = 3;

    private string _isUserExistingErrorText = string.Empty;
    private string _isPasswordRightErrorText = string.Empty;
    private bool IsUserExisting => string.IsNullOrEmpty(_isUserExistingErrorText);
    private bool IsPasswordRight => string.IsNullOrEmpty(_isPasswordRightErrorText);

    protected override void OnInitialized()
    {
        _validator = new LoginModelValidator();
    }

    private async Task OnLoginAsync()
    {
        _isUserExistingErrorText = string.Empty;
        _isPasswordRightErrorText = string.Empty;

        await WriteLog(_model);

        await _form.Validate();
        await WriteLog(_model);

        if (_form.IsValid == false)
            return;

        if ((await _validator.ValidateAsync(_model)).IsValid == false)
            throw new Exception();

        try
        {
            var challenge = await AuthService.StartHandshake(_model.Email);
            await WriteLog(challenge);

            var task = AuthService.EndHandshake(challenge, _model.Email, _model.Password);
            await task;

            if (task.IsCompletedSuccessfully)
                NavTo("/", true);
        }
        catch (TooManyRequestsException ex)
        {
            await WriteError(ex.Message);
            _attemptsCount = 0;
        }
        catch (ProblemOfPropertyException ex)
        {
            await WriteError(ex.Message);

            if (ex.Content != null)
            {
                await WriteError(ex.Content);

                switch (ex.Content.PropertyName)
                {
                    case "password":
                        --_attemptsCount;
                        _isPasswordRightErrorText = ex.Content.ErrorMessage ?? "The Password isn't right";
                        return;
                    case "email":
                        await WriteError("INVALID EMAIL");
                        throw;
                    case "nonce":
                        await OnLoginAsync();
                        break;
                    default:
                        throw;
                }
            }
        }
        catch (NotFoundException ex)
        {
            await WriteError(ex.Message);
            _isUserExistingErrorText = ex.Content ?? "The User doesn't exist";
        }
        catch (BadRequestException ex)
        {
            await WriteError(ex.Message);
            _attemptsCount = 0;
        }
    }
}